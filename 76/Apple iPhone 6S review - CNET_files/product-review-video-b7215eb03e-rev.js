define(["jquery","version!fly/managers/debug","managers/tealium","managers/page-vars","version!fly/components/base","components/"+("string"==typeof CnetPageVars.tracking.data.testGroup&&"uvp"===CnetPageVars.tracking.data.testGroup?"cnet-video-uvp":"cnet-video")],function(e,t,a,n){t=t.init("productReviewVideo"),e.widget("cnet.productReviewVideo",e.fly.base,{options:{closeButtonParent:"#mediaCarousel",shouldAutoplay:!1,scrollOnClick:!1,videoParent:"#mediaCarousel",playVideoElement:".videoSlide",uvpContainer:".videoContainer",bgContainer:null,dwTag:null,videoData:null},playerLoaded:!1,playBackStarted:!1,playerOpen:!1,autoPlayInitiated:!0,$player:null,$playerPdk:null,$playerUvp:null,timer:null,_create:function(){t.log("_create"),this._setup(),this._findPlayer(),this._setupPlayerListeners(),this.initializeVideo()},_findPlayer:function(){this.$player=e(this.options.videoParent+" .cnetVideoPlayer"),this.$playerPdk=this.$player.find("object"),this.$playerUvp=e(this.options.uvpContainer).find("[data-component=cnetVideoUvp]")},_setupPlayerListeners:function(){t.log("_setupPlayerListeners");var a=this;e(a.options.videoParent).on("onPlayerLoaded",function(e){t.log("onPlayerLoaded"),a.playerLoaded=!0}),a.$playerUvp.on("onPlaylistStart_cbsi",function(e){t.log("onPlaylistStart_cbsi"),a.playBackStarted=!0,a.playerOpen||a.toggleVideoPlayerVisibility()}),a.$playerUvp.on("onPlayerLoaded_cbsi",function(n){t.log("onPlayerLoaded_cbsi"),e(a.options.uvpContainer).removeClass("init").addClass("hide"),a.playerLoaded=!0}),a.$element.on("onStateChange_cbsi",function(e,t){1==t&&0==a.$element.find(".popOut").length&&a._makeCloseButton()}),a.$playerUvp.find("video").on("webkitendfullscreen",e.proxy(a.fullScreenChangeHandler,a));var n=(a.$player.data("cnetVideo"),a.$player.data("cnetVideo"));n&&n.readyToPlay?a.playerLoaded=!0:a.$element.find(a.options.videoParent).addBack(a.$element).on("onShowPlayOverlay",function(e){t.log("onShowPlayOverlay"),a.playerLoaded=!0}),a.options.playFullScreen&&(document.addEventListener("fullscreenchange",e.proxy(a.fullScreenChangeHandler,a)),document.addEventListener("webkitfullscreenchange",e.proxy(a.fullScreenChangeHandler,a)),document.addEventListener("mozfullscreenchange",e.proxy(a.fullScreenChangeHandler,a)),document.addEventListener("MSFullscreenChange",e.proxy(a.fullScreenChangeHandler,a))),e(".autoFeatureVideo [data-component='videoPlaylistConnector']").on("playlistClick",function(){null!=a.options.dwTag&&(window.dwTag=a.options.dwTag),a.$element.find(a.options.closeButtonParent).removeClass("isPaused"),a.showPlayer()})},fullScreenChangeHandler:function(){t.log("fullScreenChangeHandler");var e=document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement;e?t.log("fullScreenChangeHandler: entering full screen"):t.log("fullScreenChangeHandler: exiting full screen")},_waitForPlayerLoad:function(){t.log("_waitForPlayerLoad"),this.playerLoaded?(clearTimeout(this.timer),this.toggleVideo(null,!1)):this.timer=setTimeout(e.proxy(this._waitForPlayerLoad,this),250)},initializeVideo:function(){var i=this,o=i.$element.find(i.options.playVideoElement).addBack(i.$element).last();t.log("initializeVideo",o),o.click(function(t){e(this).hasClass("videoPlaying")||(null!=i.options.dwTag&&(window.dwTag=i.options.dwTag,a.trackCustomEvent("trackRelatedVideos",{clickGenericText:"carousel"},"trackClick")),i.toggleVideo(t,!0))}),o.mouseover(function(){i.options.bgContainer&&e(i.options.bgContainer).addClass("hovered")}),o.mouseout(function(){i.options.bgContainer&&e(i.options.bgContainer).removeClass("hovered")}),this.$element.find('[data-item="playOverlay"]').show(),n.noAdBlock||(e(i.options.uvpContainer).removeClass("init").addClass("hide"),i.playerLoaded=!0),"#autoplay"==window.location.hash&&i.toggleVideo("autoplay",!1)},_makeCloseButton:function(){var t=this;if(!(e(t.options.videoParent+" .closeButton").length>0)){var a="<div class='closeButton'>&nbsp;</div>";t.$element.parent().find(t.options.closeButtonParent).prepend(a),t.$element.addClass("videoPlaying"),t.$element.find(".closeButton").click(function(e){e.stopPropagation(),t.$element.find(".closeButton").remove(),t.$element.removeClass("videoPlaying"),t.$element.find(t.options.videoParent).removeClass("isPaused"),t._trackCloseButton(e),t.toggleVideo(null,!1)})}},toggleVideoPlayerVisibility:function(){var t=this;this.playerOpen?(t.$player.addClass("hide"),t.$playerPdk.addClass("hide"),e(t.options.uvpContainer).addClass("hide")):(t.$player.removeClass("hide"),t.$playerPdk.removeClass("hide"),e(t.options.uvpContainer).removeClass("hide")),t.playerOpen=!t.playerOpen},showPlayer:function(){this.playerOpen=!1,this.toggleVideoPlayerVisibility(),this._makeCloseButton()},toggleVideo:function(a,i){var o=this;if(!n.noAdBlock){if("autoplay"===a)return;return void o.toggleVideoPlayerVisibility()}i=null!=i?i:!0;try{a.stopPropagation()}catch(l){}var r=e("[data-cnet-video-options]",o.$element).data("cnetVideoOptions"),d={};r&&r.videos&&r.videos.length>0&&(d.videoTitle=r.videos[0].title||r.videos[0].headline,d.videoId=r.videos[0].mpxRefId,d.videoSegments="0:M:0",d.collectionId=[null!=r.videos[0].primaryCollection?r.videos[0].primaryCollection.id:null]),"none"==o.$player.css("display")&&o.$player.css("display","block");var s=o.$player.find(".tpPlayer").attr("id");if(t.log("playerOpen",o.playerOpen),o.playerOpen)0==this.$playerUvp.length?(t.log("pause pdk"),window.$pdk.controller.pause(!0,[s])):(t.log("pause uvp"),this.$playerUvp.cnetVideoUvp("pause")),o.toggleVideoPlayerVisibility(),o.playerOpen=!1,t.log("playerOpen",o.playerOpen);else{if(!o.playerLoaded)return void o._waitForPlayerLoad();if(o.playBackStarted)if(o.toggleVideoPlayerVisibility(),o._makeCloseButton(),0==this.$playerUvp.length)window.$pdk.controller.pause(!1,[s]),i&&o.$player.cnetVideo("trackPerformanceEvent","playclick");else{if("undefined"!=typeof o.$playerPdk[0]&&"undefined"!=typeof o.$playerPdk[0].playVideo)o.$playerPdk[0].playVideo();else if(null==o.options.videoData)o.$playerUvp.cnetVideoUvp("unpause");else{var p=JSON.parse(o.$playerUvp.cnetVideoUvp("getVideoInfo")).id;p!=o.options.videoData[0].id?o.$playerUvp.cnetVideoUvp("playVideoClip",0,o.options.videoData):o.$playerUvp.cnetVideoUvp("unpause")}i&&this.$playerUvp.cnetVideoUvp("trackPerformanceEvent","playclick")}else o.$element.find(o.options.videoParent).addBack(o.$element).on("onReleaseStart",function(e){t.log("onReleaseStart"),o.playerOpen||o.toggleVideoPlayerVisibility()}),o.$element.find(o.options.videoParent).addBack(o.$element).on("onMediaStart",function(e){o._makeCloseButton()}),0==this.$playerUvp.length?(t.log("Starting PDK playback"),o.$player.cnetVideo("clickPlayButton",i)):(t.log("Starting UVP playback"),o.toggleVideoPlayerVisibility(),o.$playerUvp.cnetVideoUvp("playVideo")),o.playBackStarted=!0}},_trackCloseButton:function(e){a.trackCustomEvent("closeButtonClick",{levtType:"ria",event:"log",mapp:"reviews4505",comp:"closeButton",comptyp:"click",riaevent:"click",pageType:n.tracking.data.pageType,siteEdition:n.tracking.data.siteEdition,brand:n.tracking.data.brand,siteType:n.tracking.data.siteType,deviceType:n.tracking.data.deviceType,siteSection:n.tracking.data.siteSection,_pageChannelType:n.tracking.data._pageChannelType,articleId:n.tracking.data.articleId,articleTitle:n.tracking.data.articleTitle,articleType:n.tracking.data.articleType,siteHier:n.tracking.data.siteHier,_pageTitle:n.tracking.data._pageTitle,clickGenericText:"close-video"},"trackClick")}})});