define(["jquery","version!fly/managers/debug","managers/page-vars","managers/edition","managers/tealium","version!fly/utils/url-helper","managers/device","managers/client-storage","translations/video","components/video-controls","components/swfobject","components/global-modal","version!fly/components/base","version!libs/jquery/lazyload","version!libs/jquery/ui/jquery.ui.position","version!libs/jquery/ui/jquery.ui.draggable","version!libs/waypoints/jquery.waypoints"],function(e,t,i,a,n,s,o,r,l){t=t.init("cnetVideoUvp"),window.mpulseUserTiming={adend:0,showplayoverlay:0,cnetvideocreate:0,playerloaded:0,contentstart:0,releaselected:0,adstart:0,initpdk:0},e.widget("cnet.cnetVideoUvp",e.fly.base,{options:{autoplay:!1,playerWrapperId:"",swfUrl:"//vidtech.cbsinteractive.com/player/3_6_3/CBSI_PLAYER_HL.swf",plugins:["//vidtech.cbsinteractive.com/plugins/closed_captions/3_6_0/Captions.swf","//vidtech.cbsinteractive.com/plugins/akamai/3_6_0/AkamaiAnalytics.swf"],uvpConfig:"/bundles/cnetvideo/gecko/config/uvp_video.xml",hi5js:"//vidtech.cbsinteractive.com/h5/2_4_1/CBSI_PLAYER.js",controlsCss:"/css/video/htmlPlayerControls/controls.css",ima3js:"https://s0.2mdn.net/instream/html5/ima3.js",ima3swf:"//vidtech.cbsinteractive.com/plugins/ima3/3_6_2/CBSI_IMA.swf",timeRange:"",controlsClass:"videoControls",popOnScroll:!1,popOutOffset:-160,popOutReturn:!0,playFullScreen:!1,timelineContainer:null},config:null,playerType:null,playlist:null,video:null,currentIndex:0,videoEnded:!1,containerId:null,playerId:null,imaId:null,$control:{},normalControls:null,player:null,assetType:null,isAd:!1,isPlaying:!1,poppedOut:!1,popOutWaypoints:[],policy:"",playbackStarted:!1,omnitureParams:null,dwParams:null,omnitureAdParams:null,lastPercentComplete:0,currentSegment:null,currentDuration:0,segmentTimePlayed:0,adPos:"PRE",chapterData:[],queuingNewPlaylist:!1,_create:function(a){if(t.log("player",this.options),t.log("player",this.options.videos),this._setup(),this.playlist=this.options.videos,this.video=this.playlist[0],e('script[data-item="abCheck"]',this.$element).length>0&&!i.noAdBlock){this.displayAlert(l.adBlock.title,l.adBlock.message),this.trackPerformanceEvent("adblock");var n=e.extend({clickGenericText:"adBlockEnabled",pageType:i.tracking.data.pageType,brand:i.tracking.data.brand,siteEdition:i.tracking.data.siteEdition,siteType:i.tracking.data.siteType,deviceType:i.tracking.data.deviceType,siteSection:i.tracking.data.siteSection,_pageChannelType:i.tracking.data._pageChannelType,articleId:i.tracking.data.articleId,articleTitle:i.tracking.data.articleTitle,articleType:i.tracking.data.articleType,siteHier:i.tracking.data.siteHier,_pageTitle:i.tracking.data._pageTitle},this.omnitureParams,this.dwParams);return this.trackCustomEvent("trackClick",n),void this._lazyLoadImages()}o.isMobileUserAgent()||o.isIPhone()||o.isIPad()?this.playerType="html":this.hasFlash()?this.playerType="flash":(this.trackPerformanceEvent("noflashdetected"),this.playerType="html"),(o.isMobileUserAgent()||o.isIPad())&&(this.options.autoplay=!1),this.config=this.options.config,t.log("config",this.config),this._initIframeTracking(),this._createContainer(),this._createUvpOpts(),this.$normalControls=this.$element.parent().find('[data-component="videoControls"]');var s=this.options;this.policy=s.config.policies["default"],this.trackPerformanceEvent("cnetvideocreate"),window.isJSReady=e.proxy(this.isJSReady,this),window.onCBSIPlayerReady=e.proxy(this.onCBSIPlayerReady,this),"flash"==this.playerType?this.createFlashPlayer():this.createHtmlPlayer(),this.initChapterStarts()},_initIframeTracking:function(){if("video_share"==window.CnetPageVars.pageType&&window.location!==window.parent.location)try{window.utag_data=window.parent.utag_data,i=window.parent.CnetPageVars,t.log("updated CnetPageVars",i)}catch(e){t.log("Couldn't get CnetPageVars from parent")}},_initTrackingData:function(){this.omnitureParams={channel:"video",videoContentType:"video",videoTitle:this.video.title||this.video.headline,videoId:this.video.mpxRefId,videoPartnerId:this.partnerId,articleAuthorId:[null!=this.video.author?this.video.author.id:null],articleAuthorName:[null!=this.video.author?this.video.author.firstName+" "+this.video.author.lastName:null],collectionId:[null!=this.video.primaryCollection?this.video.primaryCollection.id:null]},this.dwParams={medastid:595,mapp:"UVP",medtitle:this.video.title||this.video.headline,medid:this.video.id,pageurl:document.location.href,v17:this.video.primaryTopic.id,V19:"video",v22:this.video.mpxRefId},t.log("this.omnitureParams",this.omnitureParams)},_createContainer:function(){this.containerId="cnetVideo"+Math.floor(1e4*Math.random()),this.$element.attr("id",this.containerId),this.playerId=this.containerId+"_player",this.imaId=this.containerId+"_ima",this.$element.append('<div class="playerContainer"></div>'),this.$element.find(".playerContainer").append('<div id="'+this.playerId+'"></div>'),"html"==this.playerType&&(this.$element.find("#"+this.playerId).addClass("hi5"),this.$element.find(".playerContainer").append('<div id="'+this.imaId+'"></div>')),e("head").append('<link rel="stylesheet" href="'+this.options.controlsCss+'" type="text/css" media="screen" charset="utf-8"/>')},_createUvpOpts:function(){t.log("_createUvpOpts"),window.uvp_sOpts||(window.uvp_sOpts={},window.uvp_sOpts.partner="cnet",window.uvp_sOpts.netwk="cnet",window.uvp_sOpts.cms="platform",window.uvp_sOpts.uvpc=this.config.uvpConfig,window.uvp_sOpts.nativeControls=null==o.isIPhone()?!1:!0,window.uvp_sOpts.autoHide=!1,window.uvp_sOpts.plugins=this.options.plugins.toString(),window.uvp_sOpts.adp=this.options.ima3swf,uvp_sOpts.includeFullScreenButton=!0,uvp_sOpts.useNativeFullScreen=!0,uvp_sOpts.uvpHandlesAdClicks=!0,uvp_sOpts.showPreviewOnVideoEnd=!0,window.uvp_sOpts.landscape16x9_normal=["100%",this.playerHeight+"px","0px","0px"],window.uvp_sOpts.portrait16x9_normal=["100%",this.playerHeight+"px","0px","0px"],window.uvp_sOpts.landscape4x3_normal=["100%",this.playerHeight+"px","0px","0px"],window.uvp_sOpts.portrait4x3_normal=["100%",this.playerHeight+"px","0px","0px"],window.uvp_sOpts.logWindow=document.location.search.indexOf("cnetVideo")>0),t.log(window.uvp_sOpts)},getPartnerName:function(){var e="",t="cnet",a="",n="misc";return i.tracking.data&&(n=i.tracking.data.siteSection,e=433==i.tracking.data.siteId?"es-":""),"mobile"==i.device&&(a="_mobile"),e+t+a+"/"+n},playVideo:function(){t.log("playVideo",this.playlist),this.queuingNewPlaylist=!0;var e=this.getReleaseUrl(this.getPid());t.log("playVideo",e),this.player.loadVideoBySelector(e,window.uvp_sOpts.partner),1==this.options.playFullScreen?this.$normalControls.videoControls("enterFullScreen"):(this.$element.find(".videoPromo").hide(),this.$element.find(".playerContainer","#"+this.playerId).css("visibility","visible"))},playNextVideo:function(){if(t.log("playNextVideo",this.playlist),this.playlist.length>1){var e=this.playlist.shift();this.playlist.push(e),this.playVideo()}},createHtmlPlayer:function(){t.log("createHtmlPlayer"),this.options,require(["uvp_hi5","google-ima"],function(){})},createFlashPlayer:function(){t.log("createFlashPlayer");var e=this.options,i=e.swfUrl,a=this.playerId,n="100%",s="100%",o="11.0.0",r=!1,l=window.uvp_sOpts,d={allowScriptAccess:"always",allowFullScreen:"true",salign:"tl",wmode:"opaque",menu:"false",bgcolor:"#000000"},c={name:this.playerId,"class":"cnetVideoObj",style:"pointer-events:auto;"},p=!1;t.log("swfobject",i,a,n,s,o,r,l,d,c,p),window.swfobject.embedSWF(i,a,n,s,o,r,l,d,c,p)},isJSReady:function(){return!0},onCBSIPlayerReady:function(i){t.log("onCBSIPlayerReady: "+typeof i+" = "+i),"string"==typeof i?(t.log("onCBSIPlayerReady: Flash",i),this.player=e("#"+i)[0]):(t.log("onCBSIPlayerReady: Hi5",i),this.player=i,t.log(i)),this.trackPerformanceEvent("initpdk"),this._relayEvent("onCBSIPlayerReady",{player:this.player,element:this.$element}),window.onContentStart_cbsi=e.proxy(this.onContentStart_cbsi,this),this.player.addEventJSCallback("onContentStart_cbsi","onContentStart_cbsi"),window.onContentEnd_cbsi=e.proxy(this.onContentEnd_cbsi,this),this.player.addEventJSCallback("onContentEnd_cbsi","onContentEnd_cbsi"),window.onAdStart_cbsi=e.proxy(this.onAdStart_cbsi,this),this.player.addEventJSCallback("onAdStart_cbsi","onAdStart_cbsi"),window.onAdEnd_cbsi=e.proxy(this.onAdEnd_cbsi,this),this.player.addEventJSCallback("onAdEnd_cbsi","onAdEnd_cbsi"),window.onPlaylistStart_cbsi=e.proxy(this.onPlaylistStart_cbsi,this),this.player.addEventJSCallback("onPlaylistStart_cbsi","onPlaylistStart_cbsi"),window.onPlayListEnd_cbsi=e.proxy(this.onPlayListEnd_cbsi,this),this.player.addEventJSCallback("onPlayListEnd_cbsi","onPlayListEnd_cbsi"),window.onPlayerLoaded_cbsi=e.proxy(this.onPlayerLoaded_cbsi,this),this.player.addEventJSCallback("onPlayerLoaded_cbsi","onPlayerLoaded_cbsi"),window.onStateChange_cbsi=e.proxy(this.onStateChange_cbsi,this),this.player.addEventJSCallback("onStateChange_cbsi","onStateChange_cbsi"),window.onVideoProgress=e.proxy(this.onVideoProgress,this),this.player.addEventJSCallback("onVideoProgress","onVideoProgress"),window.onAdResourcesInfo=e.proxy(this.onAdResourcesInfo,this),this.player.addEventJSCallback("onAdResourcesInfo","onAdResourcesInfo"),window.onAdVideoClick=e.proxy(this.onAdVideoClick,this),this.player.addEventJSCallback("onAdVideoClick","onAdVideoClick"),document.addEventListener("fullscreenchange",e.proxy(this.fullScreenChangeHandler,this)),document.addEventListener("webkitfullscreenchange",e.proxy(this.fullScreenChangeHandler,this)),document.addEventListener("mozfullscreenchange",e.proxy(this.fullScreenChangeHandler,this)),document.addEventListener("MSFullscreenChange",e.proxy(this.fullScreenChangeHandler,this)),"html"==this.playerType&&(t.log("onCBSIPlayerReady initialize: ",this.playerId,this.containerId,this.imaId),this.player.initialize(this.playerId,this.containerId,this.imaId,"learnMoreAdClickThruID")),t.log("onCBSIPlayerReady done.")},onContentStart_cbsi:function(i){t.log("onContentStart_cbsi: "),t.log("onContentStart_cbsi: ",i),this._relayEvent("onContentStart_cbsi",i),this.trackPerformanceEvent("contentstart"),this.isAd=!1,this.videoEnded=!1,this.segmentTimePlayed=0,this.currentSegment="0:M:0",params=e.extend({videoSegments:this.currentSegment},this.omnitureParams,this.dwParams),this.trackVideo("play",0,params),this.adPos="MID",this._comscoreTracking(),this._nielsenTracking()},onContentEnd_cbsi:function(i){this.videoEnded&&(t.log("onContentEnd_cbsi: "+i),this._relayEvent("onContentEnd_cbsi",i),this.trackPerformanceEvent("contentend"),this.currentSegment="4:M:75-100",params=e.extend({videoSegments:this.currentSegment,videoTime:Math.ceil(this.currentDuration/4)-this.segmentTimePlayed},this.omnitureParams),e.inArray("dw",this.plugins)>-1&&e.extend(params,this.dwParams),this.trackVideo("play",100,params),this.adPos="POST")},onAdStart_cbsi:function(i){t.log("onAdStart_cbsi: ",this.video),this._relayEvent("onAdStart_cbsi",i),this.isAd=!0,this.trackPerformanceEvent("adstart"),this.segmentTimePlayed=0,this.currentSegment="0:A:"+this.adPos+":0:1",this.omnitureAdParams=e.extend({videoAdIds:this.video.id,videoAdTitle:this.video.title},this.omnitureParams),params=e.extend({videoSegments:this.currentSegment},this.omnitureAdParams),this.trackVideo("ad",0,params),this._comscoreTracking()},onAdEnd_cbsi:function(i){t.log("onAdEnd_cbsi: "+i),this._relayEvent("onAdEnd_cbsi",i),this.trackPerformanceEvent("adend"),this.currentSegment="4:A:"+this.adPos+":0:1",params=e.extend({videoSegments:this.currentSegment,videoTime:Math.ceil(this.currentDuration/4)-this.segmentTimePlayed},this.omnitureAdParams),this.trackVideo("ad",100,params)},onPlaylistStart_cbsi:function(e){t.log("onPlaylistStart_cbsi: ",e),this.queuingNewPlaylist=!1,this.video=this.playlist[this.currentIndex],this._initTrackingData(),this.$element.parent().find("[data-video-info-title]").text(this.playlist[this.currentIndex].title||""),this._lazyLoadImages(),this._updateVideoInfoHtml(),this.trackPerformanceEvent("releasestart"),this._relayEvent("onPlaylistStart_cbsi",this.playlist[this.currentIndex]),t.log("/onPlaylistStart_cbsi: ",e)},onPlayListEnd_cbsi:function(e){t.log("onPlayListEnd_cbsi: "+e),this._relayEvent("onPlayListEnd_cbsi",e),this.queuingNewPlaylist===!1&&this.playNextVideo()},onAdResourcesInfo:function(e){t.log("onAdResourcesInfo: ",e),this._relayEvent("onAdResourcesInfo",e)},onAdVideoClick:function(){t.log("onAdVideoClick"),this._relayEvent("onAdVideoClick")},onVideoProgress:function(i){this._relayEvent("onVideoProgress",i),this.currentDuration=this.player.getDuration(),this.options.popOnScroll&&0==this.popOutWaypoints.length&&(this._setupPopOnScroll(),this.initPopOut());var a=[75,50,25],n=!1,s=100*this.player.getCurrentTime()/this.player.getDuration();for(milestone in a)if(s>=a[milestone]&&this.lastPercentComplete<a[milestone]){n=a[milestone];break}if(n&&(this.isAd?(this.currentSegment=(75==n?"3":50==n?"2":"1")+":A:"+this.adPos+":0:1",params=e.extend({videoSegments:this.currentSegment,videoTime:Math.ceil(this.currentDuration/4)-this.segmentTimePlayed},this.omnitureAdParams),this.trackVideo("ad",n,params)):(this.currentSegment=75==n?"3:M:50-75":50==n?"2:M:25-50":"1:M:0-25",params=e.extend({videoSegments:this.currentSegment,videoTime:Math.ceil(this.currentDuration/4)-this.segmentTimePlayed,gestval:"pct:"+n},this.omnitureParams),this.trackVideo("play",n,params)),this.segmentTimePlayed=0),this.lastPercentComplete=s,this.lastPercentComplete>=99&&!this.isAd&&!this.videoEnded&&(this.videoEnded=!0),0==this.isAd){var o=1e3*Math.round(this.player.getCurrentTime());if(o){var r="time"+o.toString();this.chapterData[r]&&this.chapterData[r].hasSeen===!1&&(t.log("timelineEvent",this.chapterData[r]),this.chapterData[r].hasSeen=!0,this._relayEvent("timelineEvent",this.chapterData[r],this.options.timeLineContainer))}}},onPlayerLoaded_cbsi:function(i){if(t.log("onPlayerLoaded_cbsi: "+i),this._relayEvent("onPlayerLoaded_cbsi",{player:this.player,element:this.$element}),this.trackPerformanceEvent("playerloaded"),this.trackPerformanceEvent("playerloaded"+this.playerType.toLowerCase()),e('[data-item="loadingCircle"]',this.$element).remove(),1==this.options.autoplay)t.log("onPlayerLoaded_cbsi: play video"),this.playVideo();else{t.log("onPlayerLoaded_cbsi: show playOverlay");var a=this;a._lazyLoadImages(),this.$element.find(".videoPromo").show().on("click",function(){e(this).hide(),1==a.options.playFullScreen?(a.playbackStarted?a.unpause():a.playVideo(),a.$normalControls.videoControls("enterFullScreen")):(a.$element.find(".playerContainer","#"+a.playerId).css("visibility","visible"),a.playVideo()),a.playbackStarted=!0,a.trackPerformanceEvent("playclick")}),this.$element.find(".playerContainer","#"+this.playerId).css("visibility","hidden"),this.trackPerformanceEvent("showplayoverlay")}},fullScreenChangeHandler:function(){t.log("fullScreenChangeHandler"),this.isFullscreen()?t.log("entering full screen"):(t.log("exiting full screen"),this.$element.find(".playerContainer","#"+this.playerId).css("visibility","visible"))},isFullscreen:function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement},_updateVideoInfoHtml:function(){if(this.options.vidInfoContainer){var e=this.$element.parents(this.options.vidInfoContainer);try{e.find("[data-video-info-title]").text(this.video.title||""),e.find("[data-video-info-description]").text(this.video.description||""),e.find("[data-video-info-author").text(this.video.author.firstName||" "+this.video.author.lastName||""),e.find("[data-video-info-collection").text(this.video.primaryCollection.title||"")}catch(t){}}},_setAssetType:function(){t.log("_setAssetType",this.playerType),"html"==this.playerType?o.isIPhone()?asset="hls_phone":o.isIPad()?asset="hls_tablet":o.isMobileUserAgent()?asset="3g":asset="wifi":null!=this.video.files.hds?asset="hds":asset="rtmp",t.log("_setAssetType() - Filtering on "+asset),this.assetType=asset},getPid:function(e){null==this.assetType&&this._setAssetType();var i=void 0===e?this.assetType:e,a=this.playlist[this.currentIndex].files;if(t.log("getPid",i),t.log("getPid",a),void 0===a[i]||a[i]===!1){var n=a.wifi||a["3g"];return t.log("defaultType",n),n}return a[i]},getReleaseUrl:function(e){t.log("getReleaseUrl() "+e);var i=!0;"wifi"==this.assetType&&(i=!1);var a=document.location.protocol+"//link.theplatform.com/s/kYEXFC/"+e+"?format=SMIL&mbr="+i;return a+=this.getAdPolicyParams()+this.options.timeRange,this.options.timeRange="","hds"==this.assetType&&(a+="&manifest=f4m&formats=MPEG4"),t.log("getReleaseUrl() "+a),a},getAdPolicyParams:function(){t.log("getAdPolicyParams");var a=this.policy,n=i.ads.data.gpt.targeting.microsite;n="string"==typeof n?n:"";var r=o.isDesktopUserAgent()?"xml_vmap1":"xml_vast2";t.log("getAdPolicyParams",a,n);var l="&policy="+a;try{l+="&partner="+this.getAdParter(),l+="&device="+("html"==this.playerType?"mobile_web":"desktop"),l+="&referrer_url="+location.href.split("#")[0],l+="&timestamp="+(new Date).getTime(),l+="&ptype="+i.tracking.data.pageType,l+="&vguid="+i.guid,l+="&session="+i.ads.data.gpt.targeting.session,l+="&sub_session="+i.ads.data.gpt.targeting.subses,l+="&cid="+i.ads.data.gpt.targeting.cid,l+="&microsite="+n,l+="&collection="+i.ads.data.gpt.targeting.collection,l+="&output="+r,l+="&mfr="+this.cleanVar(i.ads.data.gpt.targeting.mfr),l+="&carrier="+this.cleanVar(i.ads.data.gpt.targeting.carrier),l+="&section="+this.cleanVar(i.ads.data.gpt.targeting.section),l+="&userGroup="+this.cleanVar(i.ads.data.gpt.targeting.userGroup),l+="&tag="+this.cleanVar(i.ads.data.gpt.targeting.tag),l+="&edition="+this.cleanVar(i.ads.data.gpt.targeting.edition),l+="&test="+this.cleanVar(i.ads.data.gpt.targeting.test)}catch(d){t.log("couldn't set ad policy params",d)}return t.log("getAdPolicyParams",l),e.each(s.getAllParams(),function(e,t){var i=e.match(/adTargeting_(.+)/);i&&i[1]?l+="&"+i[1]+"="+t:"adNetwork"===e&&(l+="&network="+t)}),t.log("DONE getAdPolicyParams: "+l),l},cleanVar:function(e){return void 0==e||"||"==e?"":e},getAdParter:function(){var e="";return e+="es"===i.tracking.data.siteEdition?"es-cnet":"roadshow"===i.tracking.data.brand?"roadshow":"cnet","html"==this.playerType&&(e+="_mobile"),t.log("Ad parnter: "+e),e},pause:function(){this.$normalControls.videoControls("pause")},unpause:function(){this.$normalControls.videoControls("unpause"),1==this.options.playFullScreen&&this.$normalControls.videoControls("enterFullScreen")},onStateChange_cbsi:function(i){switch(i){case 0:t.log("onStateChange: stop",i);break;case 1:t.log("onStateChange: play",i),this.isPlaying=!0;break;case 2:t.log("onStateChange: pause",i),this.isPlaying=!1;try{var a=Math.ceil(this.player.getDuration()/4),n=Math.ceil(this.player.getCurrentTime());this.segmentTimePlayed=n-Math.floor(n/a)*a,0==this.isAd&&this.trackVideo("pause",this.segmentTimePlayed,e.extend({levtEventType:"videoTime",videoTime:this.segmentTimePlayed},this.omnitureParams)),t.log("onStateChange: track")}catch(s){t.log("media is probably an ad and doesn't have length/time")}}this._relayEvent("onStateChange_cbsi",i)},onVideoError:function(e){t.log("onVideoError: "+e),this._relayEvent("onVideoError",e)},playVideoClip:function(e,i){if(t.log("playVideoClip",i),i[e]!=this.playlist[this.currentIndex]){this.$element.find(".videoPromo").hide(),this.userSelectedClip=!0;var a=i.slice(e),n=i.slice(0,e);this.playlist=a.concat(n),this.currentIndex=0,t.log("playVideoClip: ",this.playlist[this.currentIndex]),this.playVideo()}},_lazyLoadImages:function(){t.log("lazyLoadImages"),e("img.lazy").lazyload({failure_limit:2e3,skip_invisible:!1,threshold:200})},_setupPopOnScroll:function(){o.isDesktopUserAgent()&&(this.autoplayControlEnabled="on"==r.read("autoplayEnabled"));var t=this,i=this.$element.closest('[data-pop-on-scroll="placeholder"]'),a=this.$element.find('[data-pop-on-scroll="drag"]'),n=this.$element.find('[data-pop-on-scroll="close"]'),s=this.$element.parent();i.length>0&&(this.popOutWaypoints.push(new Waypoint({element:i,group:"top",handler:function(e){"down"===e&&t.isPlaying&&!t.poppedOut&&t.createPopOutPlayer(),"up"===e&&t.poppedOut&&t.options.popOutReturn&&t.returnPopOutPlayer()},offset:t.options.popOutOffset})),this.popOutWaypoints.push(new Waypoint({element:i,group:"bottom",handler:function(e){"down"===e&&t.poppedOut&&t.options.popOutReturn&&t.returnPopOutPlayer(),"up"===e&&t.isPlaying&&!t.poppedOut&&t.createPopOutPlayer()},offset:function(){return e(window).height()-this.element.height()-t.options.popOutOffset}}))),a.length>0&&s.draggable({handle:a,stop:function(e){t.trackAction("drag-video")}}),n.on("click",function(i){t.pause(),t.trackAction("close-scroll-video");var a=e('.autoFeatureVideo [data-component="productReviewVideo"]');a.length>0&&(s.removeClass("popOut").addClass("hide"),a.removeClass("videoPlaying"),a.find(".closeButton").remove(),a.productReviewVideo("toggleVideoPlayerVisibility")),t.returnPopOutPlayer(!1)})},createPopOutPlayer:function(){this.isFullscreen()||(this.$element.parent().removeClass("stayPut").addClass("popOut"),e("body").addClass("floatingPlayer"),this.$normalControls.videoControls("resizeControls"),this.trackAction("scroll-video-pop-out"),this.poppedOut=!0)},returnPopOutPlayer:function(t){this.$element.parent().removeClass("popOut").addClass("stayPut"),e("body").removeClass("floatingPlayer"),this.$normalControls.videoControls("resizeControls"),this.poppedOut=!1,t!==!1&&this.trackAction("scroll-video-pop-in")},initPopOut:function(){var t=e('[data-pop-on-scroll="placeholder"]').offset().top-e(window).scrollTop();this.options.popOnScroll&&t<this.options.popOutOffset&&this.createPopOutPlayer()},trackPerformanceEvent:function(a){try{var n={event:"log",pageurl:document.location.href,siteid:i.tracking.data._siteId,mapp:"cnetvideotrack",v12:i.tracking.data.siteEdition,v13:(i.tracking.data.testName?i.tracking.data.testName:"")+"|"+(i.tracking.data.testVersion?i.tracking.data.testVersion:"")+"|"+(i.tracking.data.testGroup?i.tracking.data.testGroup:""),v16:i.guid,v17:i.tracking.data.topicId.toString(),v18:i.tracking.data.articleId,v19:i.tracking.data.pageType,v20:i.tracking.data._articleType?i.tracking.data._articleType:i.tracking.data.articleType,v21:i.tracking.data._siteTypeDevice,v23:i.tracking.data._sitePrimaryRsid,objnm:this.playlist[this.currentIndex].mpxRefId,rsid:i.tracking.data.dwAccount,riaevent:a};(new Image).src="http://dw.cbsi.com/levt/ria/e.gif?"+e.param(n),t.log("trackPerformanceEvent: "+a),t.log("trackPerformanceEvent",n)}catch(s){t.log("trackPerformanceEvent: not tracked. Missing required param.")}try{void 0===performance.getEntriesByName(a)[0]&&performance.mark("video_"+a)}catch(s){}try{var o=0;(void 0===mpulseUserTiming[a]||0===mpulseUserTiming[a])&&(mpulseUserTiming[a]=performance.now(),o=1);var r={showplayoverlay:["showoverl","playerloaded"],cnetvideocreate:["create"],playerloaded:["ploaded","initpdk"],contentstart:["cstart","adend"],releaselected:["releasele","playerloaded"],adstart:["adStart","releaselected"],initpdk:["initpdk","cnetvideocreate"]},l=r[a][0];if(l){"undefined"!=typeof BOOMR&&mPulseApp.getSessionID()!==BOOMR.session.ID&&mPulseApp.setSessionID(BOOMR.session.ID),mPulseApp.setPageGroup(i.tracking.data.soastaPageType),mPulseApp.setABTest(i.tracking.data.soastaBucket);var d=mpulseUserTiming[a];if(e.isArray(r[a])){var c=mpulseUserTiming[r[a][1]]?mpulseUserTiming[r[a][1]]:0;d=mpulseUserTiming[a+"_from_"+r[a][1]]=mpulseUserTiming[a]-c}o&&mPulseApp.sendTimer("video_"+l,mpulseUserTiming[a])}}catch(s){t.log("Error tracking "+a+": "+s)}},trackVideo:function(e,t,i){null!=this.options.config.tracking&&n.trackVideo(e,t,i)},trackCustomEvent:function(e,t,i){null!=this.options.config.tracking&&n.trackCustomEvent(e,t,i)},trackAction:function(e){null!=this.options.config.tracking&&n.trackCustomEvent("carousel",{levtType:"ria",event:"log",mapp:"reviews4505",comp:"cnetVideo",comptyp:e,clickGenericText:e,riaevent:"click",pageType:i.tracking.data.pageType,siteEdition:i.tracking.data.siteEdition,brand:i.tracking.data.brand,siteType:i.tracking.data.siteType,deviceType:i.tracking.data.deviceType,siteSection:i.tracking.data.siteSection,_pageChannelType:i.tracking.data._pageChannelType,articleId:i.tracking.data.articleId,articleTitle:i.tracking.data.articleTitle,articleType:i.tracking.data.articleType,siteHier:i.tracking.data.siteHier,_pageTitle:i.tracking.data._pageTitle},"trackClick")},_comscoreTracking:function(){if(null!=this.options.config.tracking){var e="",t="",i="";e=document.location.href,t=document.referrer,i=document.title,("undefined"==typeof e||"null"==e)&&(e=""),("undefined"==typeof t||"null"==t)&&(t=""),("undefined"==typeof i||"null"==i)&&(i=""),null!=e&&e.length>512&&(e=e.substr(0,512)),t.length>512&&(t=t.substr(0,512));var a=["https:"==document.location.protocol?"https://sb":"http://b",".scorecardresearch.com/p","?c1=","1","&c2=",escape(this.config.tracking.comscore_id),"&c3=",escape(""),"&c4=",escape(this.config.tracking.comscore_sect_id),"&c5=",escape(this.videoType),"&c6=",escape(""),"&c10=",escape("1-1"),"&c7=",escape(e),"&c8=",escape(i),"&c9=",escape(t),"&rn=",Math.random(),"&cv=2.0"].join("");a.length>2080&&(a=a.substr(0,2080)),comImg="",comImg=new Image,comImg.src=a}},_nielsenTracking:function(){if(null!=this.options.config.tracking){var e,t=Math.ceil(1e9*Math.random());e="http://secure-us.imrworldwide.com/cgi-bin/m?ci="+this.config.tracking.nielsen_cid,e+="&tl=dav0-"+escape(this.video.title),this.isAd&&(e+="&c3=st,a"+escape("StreamType")),e+="&c6=vc,"+this.config.tracking.nielsen_vcid+escape(""),e+="&cc=1",e+="&rnd="+t,davImg="",davImg=new Image,davImg.src=e}},checkFlashCrashed:function(){if("flash"==this.options.player){var t=!0;try{var i=e("#"+this.instance+" object");i.length>0&&"undefined"==typeof i[0].SetVariable&&(t=!1)}catch(a){}t?window.setTimeout(e.proxy(this.checkFlashCrashed,this),1e3):this.trackPerformanceEvent("flashfailed")}},hasFlash:function(){var e=!1;try{var t=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");t&&(e=!0)}catch(i){navigator.mimeTypes&&void 0!==navigator.mimeTypes["application/x-shockwave-flash"]&&navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(e=!0)}return e},_relayEvent:function(t,i){this.$element.trigger(t,[i]),null!=this.options.timelineContainer&&e(this.options.timelineContainer).trigger(t,[i])},appendEditionPrefix:function(){var e=a.getEdition();return"us"===e?"":"/"+e},getVideoInfo:function(){var e=this.video;return delete e.author,delete e.chapters,delete e.files,delete e.primaryTopic,delete e.primaryCollection,e.browser=window.navigator.userAgent,e.pageUrl=document.location.href,e.flash=this.getFlashDescription(),JSON.stringify(e)},getVideoObj:function(){return this.video},getVideoPlaylist:function(){return this.playlist},getVideoIndex:function(){return this.currentIndex},initChapterStarts:function(){if(t.log("initChapterStarts"),this.chapterData=[],this.video.chapters&&this.video.chapters.data&&this.video.chapters.data.length>0){for(var e=0;e<this.video.chapters.data.length;e++){var i=1e3*this.video.chapters.data[e].time,a="time"+i.toString();this.chapterData[a]=this.video.chapters.data[e],this.chapterData[a].hasSeen=!1,this.chapterData[a].ms=i}this.video.chapterData=this.chapterData,t.log("this.chapterData: "+this.chapterData),t.log(this.chapterData)}},getFlashDescription:function(){var e="No Flash";if(navigator.plugins&&navigator.mimeTypes.length)e=navigator.plugins["Shockwave Flash"],e&&e.description&&(e=e.description);else if(window.navigator.userAgent.indexOf("MSIE "))try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(t){}return e},displayAlert:function(i,a){e('[data-item="loadingCircle"]',this.$element).remove(),this.$element.append('<div class="videoBlocked"><div class="blocked"></div><p class="title">'+i+'</p><p class="message">'+a+"</p></div>"),t.log("displayAlert() - Ad block message displayed to user.")}})});