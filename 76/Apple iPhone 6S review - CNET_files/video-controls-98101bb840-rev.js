define(["jquery","version!fly/managers/debug","managers/edition","managers/components.desktop","managers/device","translations/video","version!libs/jquery/ui/jquery.ui.slider","version!fly/components/base"],function(e,t,s,o,i,n){t=t.init("videoControls"),e.widget("cnet.videoControls",e.fly.base,{options:{overlayClass:"overlays",controls:["playPause","playlist","progress","time","captions","volume","share","fullscreen"],fadeDelay:4e3,usePlayOverlay:!1,showAdCountdown:!1},initialized:!1,$playerComponent:null,$overlays:null,player:null,isAd:null,adLength:null,currentVideo:null,$controls:{},isScrubbing:!1,isPaused:!0,isPopped:!1,volumeLevel:.75,volumeCookie:"pVol",playerSize:{},fadeTimer:null,mouseIsOver:!1,controlsDisabled:!1,fullScreenEnabled:document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled||null!=i.isIPad(),_create:function(){if(t.log("videoControls"),this._setup(),i.isIPhone())return t.log("no videoControls for iPhone"),void this.$element.remove();var s=this;this.$element.parent().on("onPlayerLoaded_cbsi",function(o,i){t.log("onPlayerLoaded_cbsi"),s.init(i.player,i.element),s.$playerComponent.find("video").on("webkitbeginfullscreen",e.proxy(s.fullScreenHandler,s)),s.$playerComponent.find("video").on("webkitendfullscreen",e.proxy(s.fullScreenHandler,s))})},init:function(e,s){t.log("init",this.initialized),this.initialized||(this.initialized=!0,this.player=e,this.$playerComponent=s,this.playerSize={width:this.$playerComponent.width(),height:this.$playerComponent.height()},this._createOverlayContainer(),this._createControls(),this._createListeners(),this.showControls())},_createListeners:function(){t.log("_createListeners"),this.$playerComponent.on("onContentStart_cbsi",e.proxy(this.onContentStart,this)),this.$playerComponent.on("onContentEnd_cbsi",e.proxy(this.onContentEnd,this)),this.$playerComponent.on("onAdStart_cbsi",e.proxy(this.onAdStart,this)),this.$playerComponent.on("onAdEnd_cbsi",e.proxy(this.onAdEnd,this)),this.$playerComponent.on("onPlaylistStart_cbsi",e.proxy(this.onPlaylistStart,this)),this.$playerComponent.on("onStateChange_cbsi",e.proxy(this.onStateChange,this)),this.$playerComponent.on("onVideoProgress",e.proxy(this.onVideoProgress,this)),this.$playerComponent.on("onAdVideoClick",e.proxy(this.onAdVideoClick,this)),this.$playerComponent.on("onAdResourcesInfo",e.proxy(this.onAdResourcesInfo,this));var s=this;this.$mouseListener.on("mousemove",function(){s.showControls()}),this.$element.on("mouseenter",function(){window.clearTimeout(s.fadeTimer)}),this.$element.on("mouseleave",function(){s.showControls()}),e(window).on("resize",function(){t.log("window resize"),s.fullScreenElement()?s.fullScreenHandler():s.playerSize.width!=s.$playerComponent.width()&&s.resizeControls()})},showControls:function(){t.log("showControls"),this.$mouseListener.hide(),1!=this.controlsDisabled&&(this.$element.fadeIn(),window.clearTimeout(this.fadeTimer),this.fadeTimer=window.setTimeout(e.proxy(this.hideControls,this),this.options.fadeDelay))},hideControls:function(){t.log("hideControls",this.mouseIsOver,this.$currentOverlay),null==this.$currentOverlay&&(this.$mouseListener.show(),this.$element.fadeOut(),window.clearTimeout(this.fadeTimer))},disableControls:function(e){t.log("disableControls",e),this.controlsDisabled=e,this.controlsDisabled?this.hideControls():this.$mouseListener.show()},onPlaylistStart:function(e,s){t.log("onPlaylistStart: ",s),this._setCurrentVideo(s)},onContentStart:function(e,s){t.log("onContentStart: ",s),this.isAd=!1,this.disableControls(!1),this.$controls.progress.slider("enable"),this.$controls.captions.hasClass("on")&&(this.$controls.captions.removeClass("on"),this.toggleCaptions())},onContentEnd:function(e,s){t.log("onContentEnd: ",s)},onAdStart:function(e,s){t.log("onAdStart: ",s),this.isAd=!0,this.adLength=this.player.getDuration(),this.$element.parent().addClass("ad"),this.$controls.progress.slider("disable"),!this.controlsDisabled&&this.options.showAdCountdown&&this.$overlays.find(".adCountdown").show()},onAdEnd:function(e,s){t.log("onAdEnd: ",s),this.adLength=0,this.$element.parent().removeClass("ad"),this.options.showAdCountdown&&this.$overlays.find(".adCountdown").hide()},onStateChange:function(e,s){switch(t.log("onStateChange: ",s),s){case 1:this.isScrubbing=!1,0==this.resumePlaying?(this.pause(),this.updateTimeDisplay()):(this.isPaused=!1,this.resumePlaying=!0,this.$controls.play.hide(),this.$controls.pause.show());break;case 2:this.isPaused=!0,this.$controls.play.show(),this.$controls.pause.hide()}},onVideoProgress:function(e,t){var s=this.player.getCurrentTime();this.isPaused||(this.updateTimeDisplay(),this.$controls.progress&&(this.isAd||this.isScrubbing||this.$controls.progress.slider("value",s)))},updateTimeDisplay:function(){var e=this.player.getCurrentTime();if(this.$controls.time)if(this.isAd){if(t.log("Ad time:"+e+" (getCurrentTime) of "+this.player.getDuration()+" (getDuration)"),this.$controls.time.text(this.formatTime(e)+" / "+this.formatTime(this.adLength)),this.options.showAdCountdown){var s=this.adLength-e,o=0>=s?n.resumeShortly:n.resume+s+n.seconds;this.$overlays.find(".adCountdown .msg").text(o)}}else this.$controls.time.text(this.formatTime(e)+" / "+this.currentVideo.displayTime)},onAdVideoClick:function(){t.log("onAdVideoClick"),this.disableControls(!1),this.pause(),this.showControls()},onAdResourcesInfo:function(e,s){t.log("onAdResourcesInfo: ",s);try{"vpaidAd"==s[0].resourceType&&(this.disableControls(!1),this.options.showAdCountdown&&this.$overlays.find(".adCountdown").hide())}catch(o){this.disableControls(!1)}},_setCurrentVideo:function(s){t.log("_setCurrentVideo",s),this.currentVideo=s,this.currentVideo.displayTime=this.formatTime(this.currentVideo.duration),this.currentVideo.hasCaptions?this.$controls.captions.removeClass("disabled"):this.$controls.captions.addClass("disabled"),this.$overlays.children().each(function(){e(this).hide()}),this.$controls.progress.slider("option","max",this.currentVideo.duration),this.player.setVolume(this.volumeLevel),this._showChapterStarts()},_showChapterStarts:function(){if(this.currentVideo){var e=this.currentVideo;this.$controls.progressContainer.find(".chapters").empty();for(var s in e.chapterData)if(e.chapterData.hasOwnProperty(s)){t.log("Dots: "+s+" = "+e.chapterData[s],this.$controls.progress.find("chapters"));var o=100*e.chapterData[s].time/e.duration,i=Math.floor(o*this.$controls.progressContainer.width()/100);t.log("Dots: ",o,i,this.$controls.progressContainer.find(".chapters")),this.$controls.progressContainer.find(".chapters").append('<div class="chapterDot" style="left:'+i+'px" id="'+e.chapterData[s].ms+'"></div>')}}},_createOverlayContainer:function(){return null!=this.$overlays?void t.log("$overlays: created"):(this.$element.before('<div class="'+this.options.overlayClass+'"></div>'),this.$overlays=this.$element.parent().find("."+this.options.overlayClass),this.$overlays.css({width:this.playerSize.width,height:this.playerSize.height,"pointer-events":"none","margin-top":-1*this.playerSize.height}),this.$overlays.append('<div class="mouseListener"></div>'),this.$mouseListener=this.$overlays.find(".mouseListener"),this.$mouseListener.css({width:"100%",height:"100%","pointer-events":"auto",background:"#000",opacity:"0",filter:"alpha(opacity = 0)"}),void(this.options.showAdCountdown&&this.$overlays.append('<div class="adCountdown"><span class="msg"></span></div>')))},_createControls:function(){var s=this,o=s.options;t.log("_createControls:",o.controls),this.$element.append("<ul></ul>");var n=this.$element.find("ul");t.log("_createControls:",n),e.each(o.controls,function(o,l){if("fullscreen"==l&&1!=s.fullScreenEnabled)return!0;if("volume"==l&&!i.isDesktopUserAgent())return!0;switch(n.append('<li class="'+l+'">'+l+"</li>"),control=s.$element.find("."+l),s.$controls[l]=control,l){case"playPause":control.html('<div class="play"></div>'),s.$controls.play=control.find(".play"),control.append('<div class="pause"></div>'),control.append('<div class="divider"></div>'),s.$controls.pause=control.find(".pause"),s.$controls.pause.hide(),s.$controls.play.click(e.proxy(s.unpause,s)),s.$controls.pause.click(e.proxy(s.pause,s)),s.options.usePlayOverlay&&(s.$overlays.append('<div class="isPausedOverlay overlay"><svg class="playOverlay"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#playOverlay"></use></svg></div>'),s.$playerComponent.parent().find(".isPausedOverlay").on("click",function(){s.unpause()}));break;case"playlist":s.$overlays.append('<div class="playlist overlay"><div class="playScroll"><div data-item="loadingCircle" id="loadingCircle"></div></div></div>'),control.click(e.proxy(s.togglePlaylist,s));break;case"time":control.text("0:00");break;case"progress":control.html('<div class="progress-slider"></div><div class="chapters"></div>'),s.$controls.progressContainer=control,s.$controls.progress=control.find(".progress-slider"),require(["version!libs/jquery/ui/jquery.ui.slider"],function(){s.$controls.progress.slider({range:"min",animate:100,step:.01,start:function(e,o){s.isScrubbing=!0,t.log("scrub start")},stop:function(e,o){s.isPaused?s.resumePlaying=!1:s.resumePlaying=!0,t.log("seekTo:",o.value),s.player.seekTo(o.value),window.setTimeout(function(){s.isScrubbing=!1},2e3),t.log("scrub end")}})});break;case"captions":control.click(e.proxy(s.toggleCaptions,s));break;case"volume":e.cookie(s.volumeCookie)&&(t.log("vol",e.cookie(s.volumeCookie)),s.volumeLevel=e.cookie(s.volumeCookie)),control.html('<div class="mute"></div>'),s.$controls.mute=control.find(".mute"),t.log("mute",s.$controls.mute),s.$controls.mute.click(e.proxy(s.mute,s)),control.append('<div class="volume-slider"></div>'),s.$controls["volume-slider"]=control.find(".volume-slider"),require(["version!libs/jquery/ui/jquery.ui.slider"],function(){s.$controls["volume-slider"].slider({orientation:"vertical",range:"min",max:1,step:.01,value:s.volumeLevel,slide:function(o,i){t.log(i.value),s.player.setVolume(i.value),s.player.unMute(),s.volumeLevel=i.value,e.cookie(s.volumeCookie,i.value),i.value>0&&s.$controls.mute.removeClass("off")}})}),control.hover(e.proxy(s.volumeOver,s),e.proxy(s.volumeOff,s));break;case"share":s.$overlays.append('<div class="share overlay"></div>'),control.click(e.proxy(s.toggleShareOptions,s));break;case"fullscreen":control.click(e.proxy(s.toggleFullscreen,s)),document.addEventListener("fullscreenchange",e.proxy(s.fullScreenHandler,s)),document.addEventListener("webkitfullscreenchange",e.proxy(s.fullScreenHandler,s)),document.addEventListener("mozfullscreenchange",e.proxy(s.fullScreenHandler,s)),document.addEventListener("MSFullscreenChange",e.proxy(s.fullScreenHandler,s));break;case"vertPromo":control.remove(),s.$overlays.append(e("div.vertPromo")),e("div.vertPromo").addClass("overlay"),e("div.vertPromo div").on("click",function(){e(this).parent().fadeOut()})}}),this.resizeControls(),t.log("_createControls complete")},pause:function(){this.player.pauseVideo(),this.$controls.play.show(),this.$controls.pause.hide(),this.$playerComponent.parent().addClass("isPaused")},unpause:function(){this.resumePlaying=!0,this.player.playVideo(),this.$controls.play.hide(),this.$controls.pause.show(),this.$playerComponent.parent().removeClass("isPaused")},mute:function(){this.player.getPlayerMuted()?(this.player.unMute(),this.$controls["volume-slider"].slider("value",this.volumeLevel),this.$controls.mute.removeClass("off")):(this.player.mute(),this.$controls["volume-slider"].slider("value",0),this.$controls.mute.addClass("off"))},volumeOver:function(){this.$controls["volume-slider"].show()},volumeOff:function(){this.$controls["volume-slider"].hide()},toggleCaptions:function(){this.$controls.captions.hasClass("on")?(this.$controls.captions.removeClass("on"),this.player.hideCaptions(),t.log("hideCaptions")):(this.$controls.captions.addClass("on"),this.player.showCaptions(),t.log("showCaptions"))},toggleFullscreen:function(){this.fullScreenElement()?(t.log("toggleFullscreen: exitFullScreen"),this.exitFullScreen()):(t.log("toggleFullscreen: enterFullScreen"),this.enterFullScreen())},enterFullScreen:function(){if(t.log("enterFullScreen"),t.log("enterFullScreen",this.fullScreenElement()),!this.fullScreenElement())if(this.returnToSize={width:this.$playerComponent.width(),height:this.$playerComponent.height()},i.isIPad())t.log("ipad fullscreen"),this.$playerComponent.find("video").each(function(){t.log("video",this),this.webkitEnterFullScreen()}),this.$playerComponent.find("video").attr("controls",!0);else{var e=this.$playerComponent.parent()[0],s=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullscreen;s.call(e)}},exitFullScreen:function(){this.fullScreenElement()&&(t.log("toggleFullscreen: exitFullscreen",this.playerSize),i.isIPad()?(t.log("ipad exit fullscreen"),this.$playerComponent.find("video").attr("controls",!1)):document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen())},togglePlaylist:function(){var t=this.$overlays.find(".playlist.overlay");t.is(":visible")?(this.resumePlaying&&this.unpause(),t.hide(),this.$currentOverlay=null):(this.isPaused?this.resumePlaying=!1:(this.resumePlaying=!0,this.pause()),this.$overlays.children().each(function(){e(this).hide()}),0==t.find("[data-item=viewport]").length&&this.initPlaylist(t.find(".playScroll")),t.show(),this.$currentOverlay=t)},initPlaylist:function(s){var i=this,n=this.appendEditionPrefix()+"/videos/related-videos-xhr/"+this.currentVideo.slug+"/";e.get(n,function(n){t.log("share card",n),s.html(n),o.process(s);var l=s.find("[data-item=viewport]"),r=s.find("[data-item=slide]"),a=r.outerWidth(!0),h=r.parent(),d=s.find(".prev");d.addClass("disabled");var c=s.find(".next"),u=0,p=a-a*r.length;s.find("[data-component=videoPlaylistConnector]").on("playlistClick",e.proxy(function(){this.togglePlaylist()},i)),d.on("click",function(){t.log("prev",e(this).parent().find(".next")),e(this).parent().find(".next").removeClass("disabled");var o=Math.floor(l.width()/a)*a,i=parseInt(h.css("margin-left"))+o;s.removeClass("right"),i>0&&(i=0),0==i?e(this).addClass("disabled"):e(this).removeClass("disabled"),u>=i&&h.css("margin-left",i+"px"),t.log("prev",i,u)}),c.on("click",function(){t.log("next",e(this).parent()),e(this).parent().find(".prev").removeClass("disabled");var s=Math.floor(l.width()/a)*a,o=parseInt(h.css("margin-left"))-s;p>o&&(o=p),o==p?e(this).addClass("disabled"):e(this).removeClass("disabled"),o>=p&&h.css("margin-left",o+"px"),t.log("next",o,p)})}.bind(this),"html")},toggleShareOptions:function(){var s=this.$overlays.find(".share.overlay");if(s.is(":visible"))this.resumePlaying&&this.unpause(),s.hide(),this.$currentOverlay=null;else if(this.isPaused?this.resumePlaying=!1:(this.resumePlaying=!0,this.pause()),this.$overlays.children().each(function(){e(this).hide()}),s.show(),this.$currentOverlay=s,0==s.find("[data-id="+this.currentVideo.id+"]").length){t.log("load share card"),s.empty();var i=this.appendEditionPrefix()+"/videos/video-share-xhr/"+this.currentVideo.slug+"/";e.get(i,function(e){t.log("share card",e),s.html(e),o.process(s)}.bind(this),"html")}else t.log("share options already loaded")},fullScreenHandler:function(e){return t.log("fullScreenChangeHandler"),t.log("Fullscreen mode changed",this.fullScreenElement()),this.fullScreenElement()?(this.$playerComponent.parent().hasClass("popOut")&&(this.isPopped=!0,this.$playerComponent.parent().removeClass("popOut")),this.$playerComponent.parent().addClass("fullScreenEle")):(this.isPopped&&(this.isPopped=!1,this.$playerComponent.parent().addClass("popOut")),this.$playerComponent.parent().removeClass("fullScreenEle")),i.isIPad()?(t.log("iPad doesnt need fullscreen handler"),void(void 0==this.fullScreenElement()&&this.$playerComponent.find("video").attr("controls",null))):(this.fullScreenElement()?(t.log("Enter fullscreen to",window.screen.width,window.screen.height),this.$playerComponent.parent().css({width:window.screen.width,height:window.screen.height}),this.$element.addClass("isFullscreen"),i.isAndroid()&&this.$element.addClass("android")):(t.log("Exit fullscreen"),this.$playerComponent.parent().css({width:"100%",height:"100%"}),this.$element.removeClass("isFullscreen"),i.isAndroid()&&this.$element.removeClass("android")),void this.resizeControls())},formatTime:function(e){e=Math.round(e);var t=Math.floor(e/3600),s=Math.floor((e-3600*t)/60),o=e-3600*t-60*s,i="";return i+=t>0?t+":":"",i+=s>0&&10>s?"0"+s:s,i+=":",i+=10>o?"0"+o:o},resizeControls:function(){t.log("resizeControls"),this.playerSize={width:this.$playerComponent.width(),height:this.$playerComponent.height()},this.player.setSize(this.playerSize.width,this.playerSize.height),t.log("resizeControls",this.playerSize.width,this.playerSize.height),this.$element.css("margin-left","20px"),this.$element.css("width",this.playerSize.width-40+"px");var s=this.$element.find("ul"),o=0;s.children().each(function(){e(this).hasClass("progress")?o+=e(this).outerWidth(!0)-e(this).width():"none"!=e(this).css("display")&&(o+=e(this).outerWidth(!0))}),this.$controls.progress.parent().css("width",Math.floor(this.$element.width()-o-10)),this.$overlays.css({width:this.playerSize.width,height:this.playerSize.height,"margin-top":-1*this.playerSize.height}),this._showChapterStarts(),t.log("/resizeControls")},fullScreenElement:function(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement},appendEditionPrefix:function(){var e=s.getEdition();return"us"===e?"":"/"+e}})});