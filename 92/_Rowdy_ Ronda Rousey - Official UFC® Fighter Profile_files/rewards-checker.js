var PREVIOUS_ERROR=false;function utilityNavLogin(b,a){if(b){if(typeof utilityNavLoggedIn==="function"){utilityNavLoggedIn(a)}}else{if(typeof utilityNavLoggedOut==="function"){utilityNavLoggedOut()}}}$(function _rewardsChecker_init(){var b=(function g(m){function q(w){var u=w.find("path").text(),v=w.find("param").get().map(function s(x){return{key:x.getAttribute("name"),value:x.getAttribute("value")}}),t=v.length>0;testMustache=/(?:\{\{)(\w+)(?:\}\})/;return function(y){var x=u;y=y||{};if(t){x+="?"+v.map(function(C){while(testMustache.test(C.value)){var A=testMustache.exec(C.value),D=A[1],z=A[0],B=(y.get?y.get(D):y[D])||"";C.value=C.value.replace(z,B)}return C.key+"="+encodeURIComponent(C.value)}).join("&")}return x}}function n(s){return s.innerHTML}var i=m("#ufc-rewards-settings"),r={isUfcCom:i.attr("data-is-dotcom")==="1",redirectDelay:parseInt(i.attr("data-redirect-delay"))||0,tokenCookie:i.attr("data-token-cookie"),blankRedirect:i.attr("data-blank-redirect"),ufcSsoProfile:i.attr("data-rewards-profile"),defaultDestination:i.attr("data-default-destination"),isMobile:parseInt(i.attr("data-is-mobile"))||0,redirectUrl:q(i.find(".redirect-url"))(r),ufcSsoLogin:q(i.find(".sso-login"))(r),doRedirect:i.attr("data-do-redirect")==="true",validationUrl:q(i.find(".validation-url"))(r),loginLink:function h(){return q(i.find(".login-link"))(r)},accountLink:function k(){return q(i.find(".account-link"))(r)},allowedDestinations:function p(){return i.find(".allowed-destination").get().map(n)},get:function l(s){if(!this||!this[s]){return""}else{if(typeof this[s]==="function"){this[s]=this[s]();return this.get(s)}else{return this[s]}}},on:function j(s,t){i.on(s,t)},trigger:function o(){console.log("---- Triggering "+arguments[0]+" ----");i.trigger.apply(i,arguments)}};i.data("settings",r);i.trigger("settings.ufc.rewardsChecker",r);return r})($);function c(){$("#rewardsModal").modal("hide")}$("#rewardsModal").on("hide",function(){var h='<iframe id="modalIframe" src="" align="center"></iframe>';$("#modalIframe",top.document).remove();$("#rewardsModal .modal-dialog .modal-content .modal-body").append(h)});function d(){if(top!==self){window.top.postMessage("close","*")}else{if(b.requestedDestination&&window.location.href!=b.requestedDestination){window.location.href=b.requestedDestination}}}function f(){window.onmessage=function(h){if(h.data=="close"){c();b.trigger("authenticate.ufc.rewardsChecker")}}}var e=(self!=top&&window.location.href.indexOf(b.redirectUrl)==0)||(b.blankRedirect&&window.location.href.indexOf(b.blankRedirect)!=-1);e?d():f();if(!e){var a=new PageManager(b.doRedirect,b);a.init();TokenValidator(b,a);RewardsAuthenticator(b.ufcSsoLogin,b,a);b.trigger("authenticate.ufc.rewardsChecker")}else{if(b.isUfcCom&&location.pathname=="/blank"){if(sessionStorage["ufc-rewards-savedLocation"]){location.href=sessionStorage["ufc-rewards-savedLocation"]}else{if(b.defaultDestination){location.href=b.defaultDestination}}}}});function RewardsAuthenticator(a,b,g){function h(k,l){var j="";if(k==="true"){j="loggedIn"}else{if(k==="false"){j="error"}else{if(l.getResponseHeader("UFC-SSO-STATUS")=="info needed"){j="infoNeeded"}else{j="loggedOut"}}}return j}function e(){$.ajax({url:b.ufcSsoProfile,crossDomain:true,xhrFields:{withCredentials:true},success:function(k,j,l){b.trigger("validateProfile.ufc.rewardsChecker",k)},error:function(){g.displayRegisterOrLoginLink(loginLink)}})}function f(){try{var j=$.cookie(b.tokenCookie).split("=")[1];var k=b.validationUrl+j;b.trigger("validate.ufc.rewardsChecker",k)}catch(l){g.displayRegisterOrLoginLink(loginLink)}}var d=(function(k,j){return{loggedIn:j?e:f,loggedOut:function(){g.displayRegisterOrLoginLink(k)},infoNeeded:function(){g.displayInfoNeeded(k)},error:function(){g.displayCommunicationErrorLink(k)}}})(b.get("loginLink"),b.get("isUfcCom")),i=a;b.on("authenticate.ufc.rewardsChecker",function c(){g.displayCheckingStatus();var j={url:i,crossDomain:true,success:function(l,k,m){var k=h(l,m);d[k]()},error:d.error};if(b.isUfcCom){j.xhrFields={withCredentials:true};$.ajax(j)}else{g.setupIframe("modalIframe",i);$("#modalIframe").one("load",function(){$.ajax(j)})}})}function TokenValidator(c,i){function b(j){c.trigger("validateProfile.ufc.rewardsChecker",j)}function d(j){c.trigger("loggedOut.ufc.rewardsChecker");if(!PREVIOUS_ERROR){PREVIOUS_ERROR=true;g();c.trigger("authenticate.ufc.rewardsChecker")}else{PREVIOUS_ERROR=false;i.displayRegisterOrLoginLink(f())}}function g(){$.removeCookie(c.tokenCookie);$.removeCookie(c.tokenCookie+".sig")}var f=c.get("loginLink"),e=c.get("accountLink");c.on("validate.ufc.rewardsChecker",function h(k,j){$.ajax({url:j,dataType:"json",success:b,error:d})});c.on("validateProfile.ufc.rewardsChecker",function a(m,l){if(l.error=="expired_accessToken"){g();i.displayRegisterOrLoginLink(c.get("loginLink"))}else{if(l.loyalty&&l.loyalty=="logged_in"){c.trigger("loggedIn.ufc.rewardsChecker",l);var j=c.requestedDestination;i.navigateAfterDelay(j,c.redirectDelay)}else{var k=l.name;l.first_name&&(k=l.first_name);i.displayRewardsActivationLink(k,e)}}})}function PageManager(c,a){var d=this;this.showPage=function(){setTimeout(function(){if(!$("html").hasClass("hideAll")){$("#rewardCheckerStatus").modal("hide")}else{$("html").removeClass("hideAll")}},1000)};this.init=function(){$("body").on("click",".rewardsActionLink",function(f){if(!d.isMobilePage()){f.preventDefault();d.loadContent($(this).attr("href"),$(this).attr("data-height"),$(this).attr("data-width"))}});$("#rewardCheckerStatus").modal({width:"200",height:"auto",backdrop:"static",show:false})};this.isMobilePage=function(){return isMobileBrowser()};this.displayCheckingStatus=function(){if(!$("html").hasClass("hideAll")){$("#rewardCheckerStatus .rewardCheckerMessage").html(d.messages.checkingStatus);$("#rewardCheckerStatus").modal("show")}};this.navigateAfterDelay=function(h,f){if(c){var g=false;$.each(a.allowedDestinations,function(){if(this==h){g=true}});var e=g?h:a.defaultDestination;$("#rewardCheckerStatus .rewardCheckerMessage").html(d.messages.redirecting(e));$("#rewardCheckerStatus").modal("show");setTimeout(function(){window.location.href=e},f)}};this.displayRewardsActivationLink=function(f,e){d.showPage();$("#rewardsSignupMessage").html(d.messages.rewardsActivation(f)).css("color","red");$("#joinNowButton").attr("href",e).addClass("rewardsActionLink").text(b.enable);a.trigger("missingLoyalty.ufc.rewardsChecker",f)};this.displayRegisterOrLoginLink=function(e){d.showPage();$("#rewardsSignupMessage").html(d.messages.loginRequired).css("color","red");$("#joinNowButton").attr("href",e).addClass("rewardsActionLink").text(b.join);a.trigger("loggedOut.ufc.rewardsChecker")};this.displayCommunicationErrorLink=function(e){d.showPage();$("#rewardsSignupMessage").html(d.messages.communicationError).css("color","red");$("#joinNowButton").attr("href",e).addClass("rewardsActionLink").text(b.join);a.trigger("loggedOut.ufc.rewardsChecker")};this.displayInfoNeeded=function(e){d.showPage();$("#rewardsSignupMessage").html(d.messages.infoNeeded).css("color","red");$("#joinNowButton").attr("href",e).addClass("rewardsActionLink").text(b.join);a.trigger("loggedOut.ufc.rewardsChecker");d.loadContent(e,300,500)};this.loadContent=function(f,e,g){e=(e===undefined)?600:e;d.setupIframe("modalIframe",f);if(a.isUfcCom){d.displayModal(e,g)}else{$("#modalIframe").one("load",function(){var h=$("#modalIframe")[0],i=null;try{var k=h.contentDocument||h.contentWindow.document;i=k.body.innerHTML}catch(j){d.displayModal(e,g)}})}};this.setupIframe=function(f,g){var e="#"+f;if($(e).length>0){$(e).remove()}$("<iframe></iframe>").attr({id:f,src:g}).css({width:"100%",height:"600px"}).appendTo("#rewardsModal .modal-body")};this.displayModal=function(e,f){$("#rewardsModal").modal();$("#rewardsModal").modal("show");$(".modal").css("width",f+50);$(".modal-body").css("max-height",e+50)};this.messages={redirecting:function(e){return"You are being redirected to <br/>"+e+"."},loginRequired:"Please log in to access your rewards!",checkingStatus:"Checking Reward Status",rewardsActivation:function(e){return"Welcome "+e+", enable your rewards today."},communicationError:"There was an error logging into your account. Please try again.",infoNeeded:"Your account requires additional information. Please Click below."};var b={join:"JOIN / SIGN IN",enable:"ENABLE REWARDS",account:"GO TO ACCCOUNT"}};